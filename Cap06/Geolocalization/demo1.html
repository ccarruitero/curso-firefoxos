<!DOCTYPE html>
<html>
    <head>
        <title>Curso de Firefox OS | Mozilla Perú - Devcode.la</title>
        <link href="../../css/headers.css" rel="stylesheet" type="text/css">
        <link href="../../css/lists.css" rel="stylesheet" type="text/css">
        <link href="../../css/util.css" rel="stylesheet" type="text/css">
        <link href="../../css/fonts.css" rel="stylesheet" type="text/css">
        <meta charset="utf-8">
        <style>
            #contenedor{
                border: 3px double black;
                padding: 10px;
                margin: 10px 0;
            }
        </style>
    </head>
    <body>
        
        <section role="region" id="input-areas" data-position="right">
            <header class="fixed">
                <a id="btn-input-areas-back" href="../../index.html"><span class="icon icon-back">back</span></a>
                <h1>Geolocalización</h1>
            </header>
            <article class="content scrollable header">
            <div id="contenedor">
                <p>
                    Localizacion Inicial (lat, lon): <br/>
                    <span id="iniLat">???</span>&deg;,<span id="iniLon">???</span>&deg;
                </p>
                <p>
                    Localizacion Actual (lat, lon): <br/>
                    <span id="actualLat">???</span>&deg;,<span id="actualLon">???</span>&deg;
                </p>
                <p>
                    Distancia desde el comienzo: <br/>
                    <span id="distancia"></span> km
                </p>
            </div>
            </article>
        </section>
        
        <script>
            window.onload = function(){
                
                var miLatitud;
                var miLongitud;

                function miPosicion(callback) {
                    if (!navigator.geolocation){    
                        return false;
                    }
                    function success(position) {
                        var latitude = position.coords.latitude;
                        var longitude = position.coords.longitude;
                        document.getElementById("iniLat").innerHTML = latitude;
                        document.getElementById("iniLon").innerHTML = longitude;
                        callback(latitude,longitude);   
                    }
                    function error(error) {
                        if(error.code == 0){
                            alert('Error desconocido');
                        }
                        if(error.code == 1){
                            alert('Permiso denegado');
                        }
                        if(error.code == 2){
                            alert('La posicion no se pudo determinar');
                        }
                        if(error.code == 3){
                            alert('Timed out');
                        }                        
                        // 0 => error desconocido
                        // 1 => permiso denegado
                        // 2 => posicion es inhabilitada
                        // 3 => timed out
                    }   
                    navigator.geolocation.getCurrentPosition(success, error);   
                }

                miPosicion(function(latitude,longitude){    
                    miLatitud = latitude;
                    miLongitud = longitude;

                    navigator.geolocation.watchPosition(function(position){
                        document.getElementById("actualLat").innerHTML = position.coords.latitude;
                        document.getElementById("actualLon").innerHTML = position.coords.longitude;
                        document.getElementById("distancia").innerHTML = 
                        calculateDistance(miLatitud, miLongitud,
                                      position.coords.latitude, position.coords.longitude);
                    });

                });

                function calculateDistance(lat1, lon1, lat2, lon2) {
                    var R = 6371; // km
                    var dLat = (lat2-lat1).toRad();
                    var dLon = (lon2-lon1).toRad();
                    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(lat1.toRad()) * Math.cos(lat2.toRad()) *
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    var d = R * c;
                    return d;
                }
                Number.prototype.toRad = function() {
                  return this * Math.PI / 180;
                }
            }
        </script>
    </body>
</html>
